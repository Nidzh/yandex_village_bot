from aiogram import Router, F
from aiogram.fsm.context import FSMContext
from aiogram.types import CallbackQuery
from aiogram.utils.keyboard import InlineKeyboardBuilder

from src.apps.user.service import UserService
from src.db.context import get_session
from src.tgbot.formatter import _B, _I
from src.tgbot.localization.manager import TextManager
from src.tgbot.utils import smart_edit

router = Router()


async def welcome(callback, state, text):
    async for session in get_session():
        user = await UserService(session=session).get_user_by_id(callback.from_user.id)

    if user.city == 'moscow':
        title = (f"{_B('–ü—Ä–∏–≤–µ—Ç!')}  üêæ  –≠—Ç–æ –ö–æ—Ç –£—á—ë–Ω—ã–π.\n\n–¢—ã –≤ —á–∞—Ç-–±–æ—Ç–µ Open Air –í–µ—Ä—Ç–∏–∫–∞–ª–µ–π {_I('¬´–Ø–≤—å –∏ –ù–∞–≤—å¬ª')}.\n\n–ì–æ—Ç–æ–≤—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –≤"
                 f" {_B('—Å–∫–∞–∑–æ—á–Ω–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ')}? ‚ú®")
    if user.city == 'belgrad':
        title = f"{_B('üëã –ü—Ä–∏–≤–µ—Ç!')}\n\n–¢—ã –≤ —á–∞—Ç-–±–æ—Ç–µ Open Air –í–µ—Ä—Ç–∏–∫–∞–ª–µ–π {_I('¬´–ë–∞–ª–¥—ë–∂–∫–∏–Ω–æ¬ª')}.\n\n–ì–æ—Ç–æ–≤—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –≤ {_B('—Å–∫–∞–∑–æ—á–Ω–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ')}? ‚ú®"

    kb = InlineKeyboardBuilder()
    kb.button(text="üöÄ –ù–∞—á–∏–Ω–∞–µ–º", callback_data="letsgo")
    kb.button(text="üí¨ –†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ", callback_data="about")
    kb.adjust(1)

    await smart_edit(callback, title, kb)


@router.callback_query(F.data.startswith("about"))
async def about(callback, state, text):
    async for session in get_session():
        user = await UserService(session=session).get_user_by_id(callback.from_user.id)

    kb = InlineKeyboardBuilder()

    if user.city == 'moscow':
        title = (
            f"üìÖ 22 –∞–≤–≥—É—Å—Ç–∞ –º—ã –≤—Å—Ç—Ä–µ—á–∞–µ–º—Å—è –Ω–∞ Open Air {_B('¬´–Ø–≤—å –∏ –ù–∞–≤—å¬ª')}.\n\n"
            f"‚ú® –≠—Ç–æ –¥–µ–Ω—å, –∫–æ–≥–¥–∞ –ø—Ä–∏–≤—ã—á–Ω–∞—è —Å—Ä–µ–¥–∞ —Å–º–µ–Ω–∏—Ç —Ä–∏—Ç–º:\n"
            f"‚Äî –≤ –¥–Ω–µ–≤–Ω–æ–µ –≤—Ä–µ–º—è ‚Äî {_I('–∑–∞–±–∞–≤–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏')}, –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è, –æ–±—â–µ–Ω–∏–µ –∏ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã.\n"
            f"‚Äî –∞ –±–ª–∏–∂–µ –∫ –≤–µ—á–µ—Ä—É –Ω–∞—á–Ω—ë—Ç—Å—è {_B('¬´–ù–∞–≤—å¬ª')} ‚Äî –≤–µ—á–µ—Ä–Ω—è—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Å —Ä–µ–π–≤–æ–≤–æ–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–æ–π.\n\n"
            f"üé≠ –ù–∞ –ø–ª–æ—â–∞–¥–∫–µ —Ç–µ–±—è –∂–¥—É—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞—Ü–∏–∏, —Ä–æ–ª–∏, –º–∞—Ä—à—Ä—É—Ç—ã –∏ –ª—é–¥–∏.\n"
            f"–£ –∫–∞–∂–¥–æ–≥–æ –±—É–¥–µ—Ç —Å–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è –≤–Ω—É—Ç—Ä–∏ –æ–±—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è.\n\n"
            f"üïµÔ∏è‚Äç‚ôÄÔ∏è –°–∫–æ—Ä–æ —Ä–∞—Å—Å–∫–∞–∂–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ ‚Äî –∫–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞, –∫–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∏ —á—Ç–æ –Ω–µ —Å—Ç–æ–∏—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å.\n\n"
            f"ü§ù –î–æ –≤—Å—Ç—Ä–µ—á–∏!\n\n"
            f"üìå –ê –ø–æ–∫–∞ ‚Äî –æ–∑–Ω–∞–∫–æ–º—å—Å—è —Å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é."
        )

        kb.button(text=text.main, callback_data="main")

    if user.city == 'belgrad':
        title = (
            f"‚ú® {_B('–í–∂—É—Ö!')} 22 –∞–≤–≥—É—Å—Ç–∞ –Ø–Ω–¥–µ–∫—Å –í–µ—Ä—Ç–∏–∫–∞–ª–∏ –ø—Ä–∏–≥–ª–∞—à–∞—é—Ç –≤–∞—Å –≤ {_B('¬´–ë–∞–ª–¥—ë–∂–∫–∏–Ω–æ¬ª')}!\n\n"
            f"üí´ –ó–∞–±—É–¥—å –æ–±–æ –≤—Å—ë–º –Ω–∞ —Å–≤–µ—Ç–µ –∏ –æ–∫—É–Ω–∏—Å—å –≤ {_B('—Å–∫–∞–∑–æ—á–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É')} –Ω–∞—à–µ–≥–æ —Ñ–µ—Å—Ç–∏–≤–∞–ª—è –ø–æ–¥ –æ—Ç–∫—Ä—ã—Ç—ã–º –Ω–µ–±–æ–º!\n\n"
            f"üè° –ü—Ä–µ–¥—Å—Ç–∞–≤—å: –≤–æ–ª—à–µ–±–Ω–∞—è –¥–µ—Ä–µ–≤–Ω—è, –≥–¥–µ —Ç—ã –≤—Å—Ç—Ä–µ—Ç–∏—à—å –ë–∞–±—É –Ø–≥—É, –ö–æ—â–µ—è –ë–µ—Å—Å–º–µ—Ä—Ç–Ω–æ–≥–æ –∏ –¥—Ä—É–≥–∏—Ö –ª—é–±–∏–º—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —Å–∫–∞–∑–æ–∫.\n\n"
            f"üéâ –≠—Ç–æ –±—É–¥–µ—Ç –¥–µ–Ω—å –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—Ä—ã–≤–∞ –∏ –≤–µ—Å–µ–ª—å—è –≤ –∫–æ–º–ø–∞–Ω–∏–∏ —Å–∞–º—ã—Ö —è—Ä–∫–∏—Ö –∏ –Ω–µ–æ—Ä–¥–∏–Ω–∞—Ä–Ω—ã—Ö –ª—é–¥–µ–π!\n\n"
            f"üåå –ê –≤–µ—á–µ—Ä–æ–º –¥–µ—Ä–µ–≤–Ω—è –ø—Ä–µ–æ–±—Ä–∞–∑–∏—Ç—Å—è, –∏ —Ç—ã —É–≤–∏–¥–∏—à—å –µ—ë ‚Äî –∏ —Å–µ–±—è ‚Äî —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –ø–æ-–Ω–æ–≤–æ–º—É.\n\n"
            f"üóù –ì–æ—Ç–æ–≤—ã –æ–∫—É–Ω—É—Ç—å—Å—è –≤ –º–∏—Ä —á—É–¥–µ—Å –∏ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π? {_B('–ë–∞–ª–¥—ë–∂–∫–∏–Ω–æ –∂–¥—ë—Ç!')}\n\n"
            f"üìÖ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤–æ–ª—à–µ–±–Ω—ã—Ö —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–π –º—ã —Ä–∞—Å–∫—Ä–æ–µ–º 22 –∞–≤–≥—É—Å—Ç–∞!\n\n"
            f"ü§ù –î–æ –≤—Å—Ç—Ä–µ—á–∏ –≤ —Å–∫–∞–∑–∫–µ!"
        )

    await smart_edit(callback, title, kb)


@router.callback_query(F.data.startswith("letsgo"))
async def letsgo(callback, state, text):
    async for session in get_session():
        user = await UserService(session=session).get_user_by_id(callback.from_user.id)

    kb = InlineKeyboardBuilder()

    if user.city == 'moscow':
        title = (
            f"üîú –°–∫–æ—Ä–æ —Ç—ã —É–∑–Ω–∞–µ—à—å –º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ –æ —Ñ–µ—Å—Ç–∏–≤–∞–ª–µ.\n\n"
            f"üåû –û—Ç–ª–∏—á–Ω–æ–≥–æ –¥–Ω—è!\n\n"
            f"üìå –ê –ø–æ–∫–∞ ‚Äî –æ–∑–Ω–∞–∫–æ–º—å—Å—è —Å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é."
        )

        kb.button(text=text.main, callback_data="main")

    if user.city == 'belgrad':
        title = (
            f"üìÖ –í—Å–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –º—ã —Ä–∞—Å–∫—Ä–æ–µ–º 22 –∞–≤–≥—É—Å—Ç–∞.\n\n"
            f"ü§ù –í—Å—Ç—Ä–µ—á–∞–µ–º—Å—è –≤ {_B('¬´–ë–∞–ª–¥—ë–∂–∫–∏–Ω–æ¬ª')}!"
        )

    await smart_edit(callback, title, kb)
